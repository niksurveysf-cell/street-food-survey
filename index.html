<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Street Food Survey</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f4f7fb; --card:#fff; --accent:#1a73e8; --muted:#6b7280;
      --radius:12px; --shadow:0 8px 30px rgba(20,30,60,0.08);
    }
    html,body{height:100%}
    body{
      margin:0; font-family:"Roboto", Arial, sans-serif;
      background:linear-gradient(180deg,var(--bg),#fff);
      padding:28px; display:flex; justify-content:center;
    }
    .container{ width:100%; max-width:820px; background:var(--card); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:28px; box-sizing:border-box; }
    header{ display:flex; gap:16px; align-items:center; margin-bottom:12px; }
    .logo{ width:56px; height:56px; border-radius:10px; background:linear-gradient(135deg,var(--accent),#6aa8ff);
      display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; font-size:20px; }
    h2{ margin:0; font-size:20px; color:#0f1724; font-weight:600; }
    .subtitle{ color:var(--muted); font-size:0.95rem; margin-top:4px }
    .progress{ height:8px; background:#eef5ff; border-radius:999px; overflow:hidden; margin-top:14px; }
    .progress > i{ display:block; height:100%; background:linear-gradient(90deg,var(--accent),#6aa8ff); width:0%; transition:width .25s ease; }
    #status{ color:var(--muted); margin:10px 0 18px; font-size:0.95rem }
    .field-row{ margin:14px 0; padding:12px; border-radius:10px; background:linear-gradient(180deg, rgba(250,250,252,0.6), rgba(250,250,252,0.4));
      border:1px solid #f0f3f8; display:flex; flex-direction:column; gap:8px; }
    .field-row label{ font-weight:600; color:#111827; font-size:0.98rem; }
    input[type="text"], input[type="number"], textarea, select{
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid #e6e9ef; font-size:15px; background:#fff;
    }
    .state-display{ margin-top:6px; color:#0f1724; font-weight:600; font-size:0.95rem; }
    .options{ display:flex; flex-direction:column; gap:8px; }
    .controls{ display:flex; gap:12px; align-items:center; margin-top:18px; flex-wrap:wrap; }
    button.primary{ background:var(--accent); color:#fff; border:none; padding:10px 16px; border-radius:10px; cursor:pointer; font-weight:600; }
    button.ghost{ background:transparent; color:var(--accent); border:1px solid rgba(26,115,232,0.12); padding:9px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    .hint{ color:var(--muted); font-size:0.95rem; margin-top:10px }
    @media (max-width:520px){ .container{ padding:18px } .logo{ width:48px; height:48px; font-size:18px } }
  </style>
</head>
<body>
  <div class="container" role="main">
    <header>
      <div class="logo">SF</div>
      <div>
        <h2>Street Food Survey</h2>
        <div class="subtitle">We‚Äôre bringing the combo to your block. Pick the combo. We‚Äôll deliver the vibe üòç</div>
      </div>
    </header>

    <div class="progress" aria-hidden="true"><i id="progressBar"></i></div>
    <div id="status" class="hint">Loading form‚Ä¶</div>

    <div id="formContainer" aria-live="polite"></div>

    <div class="controls">
      <button id="submitBtn" class="primary">Lock my combo</button>
      <button id="clearBtn" class="ghost">Clear local draft</button>
      <div id="submitMsg" class="hint" style="margin-left:8px"></div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyAv_jsMrG0VXxfroqJ5invTumj6C2VZoEsZA0irC7UmGuu_396yZfMDNUM1hMIFIIw_w/exec";
    const CONFIG_URL = WEBAPP_URL + "?config=1";

    // ===== City -> State and Region mapping (includes Mangaluru) =====
    const cityToState = {
      "Delhi":"Delhi","Mumbai":"Maharashtra","Bengaluru":"Karnataka","Kolkata":"West Bengal","Chennai":"Tamil Nadu",
      "Hyderabad":"Telangana","Pune":"Maharashtra","Ahmedabad":"Gujarat","Jaipur":"Rajasthan","Lucknow":"Uttar Pradesh",
      "Surat":"Gujarat","Chandigarh":"Chandigarh","Coimbatore":"Tamil Nadu","Indore":"Madhya Pradesh","Nagpur":"Maharashtra",
      "Vadodara":"Gujarat","Bhopal":"Madhya Pradesh","Patna":"Bihar","Guwahati":"Assam","Mangaluru":"Karnataka","Other":""
    };
    const cityToRegion = {
      "Delhi":"North","Mumbai":"West","Bengaluru":"South","Kolkata":"East","Chennai":"South",
      "Hyderabad":"South","Pune":"West","Ahmedabad":"West","Jaipur":"North","Lucknow":"North",
      "Surat":"West","Chandigarh":"North","Coimbatore":"South","Indore":"Central","Nagpur":"Central",
      "Vadodara":"West","Bhopal":"Central","Patna":"East","Guwahati":"Northeast","Mangaluru":"South"
    };

    // ===== session id persisted in localStorage =====
    let sessionId = localStorage.getItem("sf_session_id");
    if (!sessionId) {
      sessionId = Math.random().toString(36).slice(2, 10);
      localStorage.setItem("sf_session_id", sessionId);
    }

    // ===== autosave queue with debounce (now includes state & region) =====
    const pending = {};
    let debounceTimer = null;
    function scheduleSave(fieldName, fieldValue, itemCategory = "", price = "", region = "", state = "") {
      pending[fieldName] = { fieldValue, itemCategory, price, region, state };
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(flushPending, 350);
      updateProgressUI();
    }

    async function flushPending() {
      const entries = Object.entries(pending);
      if (!entries.length) return;
      for (const [fieldName, payload] of entries) {
        await sendToServer(fieldName, payload.fieldValue, payload.itemCategory, payload.price, payload.region, payload.state);
      }
      for (const k of entries.map(e => e[0])) delete pending[k];
    }

    async function sendToServer(fieldName, fieldValue, itemCategory = "", price = "", region = "", state = "") {
      try {
        const res = await fetch(WEBAPP_URL, {
          method: "POST",
          body: JSON.stringify({
            sessionId,
            fieldName,
            fieldValue,
            itemCategory,
            price,
            region,
            state
          })
        });
        try {
          const json = await res.json();
          if (json && json.status && json.status !== "ok") console.warn("Server returned error:", json);
        } catch (e) { /* ignore parse errors */ }
      } catch (err) {
        console.error("Save error:", err);
      }
    }

    function saveField(fieldKey, value, category = "", price = "", region = "", state = "") {
      scheduleSave(fieldKey, value, category, price, region, state);
    }

    // ===== helpers to parse config options =====
    function parseOptions(optString) {
      if (!optString) return [];
      return optString.split(/[,;]+/).map(s => {
        const parts = s.split(":");
        return { label: parts[0].trim(), price: parts[1] ? parts[1].trim() : "" };
      }).filter(o => o.label);
    }

    // ===== build form from config rows (city dropdown shows state automatically) =====
    function buildForm(config) {
      const container = document.getElementById("formContainer");
      container.innerHTML = "";
      if (!config || !config.length) {
        document.getElementById("status").textContent = "No form configuration found. Check the Config sheet.";
        return;
      }
      document.getElementById("status").textContent = "";

      config.forEach((q) => {
        const type = (q.type || "").toLowerCase();
        const labelText = q.label || q.key || "question";
        const key = q.key || ("q_" + Math.random().toString(36).slice(2,6));
        const category = q.category || "";
        const priceDefault = q.price || "";

        const wrapper = document.createElement("div");
        wrapper.className = "field-row";

        const label = document.createElement("label");
        label.textContent = labelText;
        wrapper.appendChild(label);

        function setDataKey(el) {
          el.dataset.key = key;
          el.dataset.category = category || "";
        }

        // If the config key is "city" or label mentions city, render top-20 dropdown with Mangaluru
        if (key.toLowerCase() === "city" || labelText.toLowerCase().includes("city")) {
          const sel = document.createElement("select");
          setDataKey(sel);
          const placeholder = document.createElement("option");
          placeholder.value = "";
          placeholder.textContent = "Choose your city";
          placeholder.disabled = true;
          placeholder.selected = true;
          sel.appendChild(placeholder);

          // top 20 list (includes Mangaluru)
          const cities = ["Delhi","Mumbai","Bengaluru","Kolkata","Chennai","Hyderabad","Pune","Ahmedabad","Jaipur","Lucknow",
                          "Surat","Chandigarh","Coimbatore","Indore","Nagpur","Vadodara","Bhopal","Patna","Guwahati","Mangaluru","Other"];
          cities.forEach(c => {
            const opt = document.createElement("option");
            opt.value = c;
            opt.textContent = c;
            sel.appendChild(opt);
          });

          // state display (visible to user, not editable)
          const stateDisplay = document.createElement("div");
          stateDisplay.className = "state-display";
          stateDisplay.textContent = ""; // filled on selection
          wrapper.appendChild(sel);
          wrapper.appendChild(stateDisplay);

          sel.onchange = () => {
            if (!sel.value) return;
            const chosenCity = sel.value;
            const region = cityToRegion[chosenCity] || "";
            const state = cityToState[chosenCity] || "";
            // show state to user (only state visible)
            stateDisplay.textContent = state ? ("State: " + state) : "";
            // save city, state and region as separate fields
            saveField(key, chosenCity, category, priceDefault || "", region, state);
            if (region) saveField("region", region, "", "", region, state);
            if (state) saveField("state", state, "", "", region, state);
          };
        }
        else if (type === "select" || type === "radio") {
          if (type === "select") {
            const sel = document.createElement("select");
            setDataKey(sel);
            const placeholder = document.createElement("option");
            placeholder.value = "";
            placeholder.textContent = "Select";
            placeholder.disabled = true;
            placeholder.selected = true;
            sel.appendChild(placeholder);
            parseOptions(q.options).forEach(o => {
              const opt = document.createElement("option");
              opt.value = o.label;
              opt.textContent = o.label;
              sel.appendChild(opt);
            });
            sel.onchange = () => {
              if (sel.value && sel.value !== "") saveField(key, sel.value, category, priceDefault || "");
            };
            wrapper.appendChild(sel);
          } else {
            const box = document.createElement("div");
            box.className = "options";
            parseOptions(q.options).forEach(o => {
              const row = document.createElement("label");
              row.className = "radio-item";
              const r = document.createElement("input");
              r.type = "radio"; r.name = key; r.value = o.label; r.dataset.key = key;
              r.onchange = () => saveField(key, r.value, category, o.price || "");
              row.appendChild(r);
              row.appendChild(document.createTextNode(o.label));
              if (o.price) {
                const badge = document.createElement("span"); badge.className = "price-badge"; badge.textContent = "‚Çπ" + o.price;
                row.appendChild(badge);
              }
              box.appendChild(row);
            });
            wrapper.appendChild(box);
          }
        } else if (type === "checkbox") {
          const box = document.createElement("div");
          box.className = "options";
          parseOptions(q.options).forEach(o => {
            const row = document.createElement("label");
            row.className = "checkbox-item";
            const cb = document.createElement("input");
            cb.type = "checkbox"; cb.value = o.label; cb.dataset.key = key + ":" + o.label;
            cb.onchange = () => saveField(key + ":" + o.label, cb.checked ? o.label : "", category, o.price || "");
            row.appendChild(cb);
            row.appendChild(document.createTextNode(o.label));
            if (o.price) {
              const badge = document.createElement("span"); badge.className = "price-badge"; badge.textContent = "‚Çπ" + o.price;
              row.appendChild(badge);
            }
            box.appendChild(row);
          });
          wrapper.appendChild(box);
        } else if (type === "textarea") {
          const ta = document.createElement("textarea");
          setDataKey(ta);
          ta.placeholder = q.placeholder || "";
          ta.onblur = () => saveField(key, ta.value, category, priceDefault);
          wrapper.appendChild(ta);
        } else {
          const inp = document.createElement("input");
          inp.type = q.type === "number" ? "number" : "text";
          setDataKey(inp);
          inp.placeholder = q.placeholder || "";
          inp.onblur = () => saveField(key, inp.value, category, priceDefault);
          wrapper.appendChild(inp);
        }

        container.appendChild(wrapper);
      });

      updateProgressUI();
    }

    // ===== load config from Apps Script doGet =====
    async function loadConfig() {
      try {
        const res = await fetch(CONFIG_URL, { cache: "no-store" });
        const json = await res.json();
        return json.config || [];
      } catch (e) {
        console.error("Failed to load config", e);
        document.getElementById("status").textContent = "Failed to load form configuration.";
        return [];
      }
    }

    // ===== progress UI =====
    function updateProgressUI() {
      const inputs = document.querySelectorAll("[data-key]");
      if (!inputs.length) { document.getElementById("progressBar").style.width = "0%"; return; }
      const seenKeys = new Set();
      inputs.forEach(el => {
        const k = el.dataset.key; if (!k) return;
        if (k.includes(":")) { if (el.checked) seenKeys.add(k.split(":")[0] + ":" + k.split(":")[1]); }
        else {
          if (el.type === "radio") {
            const radios = document.getElementsByName(k);
            for (const r of radios) if (r.checked) { seenKeys.add(k); break; }
          } else if (el.type === "checkbox") { if (el.checked) seenKeys.add(k); }
          else { if (el.value && el.value.toString().trim() !== "") seenKeys.add(k); }
        }
      });
      const uniqueKeys = new Set();
      inputs.forEach(el => { const k = el.dataset.key; if (!k) return; uniqueKeys.add(k.includes(":") ? k.split(":")[0] : k); });
      const percent = uniqueKeys.size ? Math.round((seenKeys.size / uniqueKeys.size) * 100) : 0;
      document.getElementById("progressBar").style.width = percent + "%";
    }

    // ===== submit all answers as one row (final submit) =====
    async function submitAll() {
      const elements = document.querySelectorAll("[data-key]");
      const grouped = {};
      elements.forEach(el => {
        const rawKey = el.dataset.key; if (!rawKey) return;
        if (rawKey.includes(":")) {
          const parts = rawKey.split(":"); const base = parts[0]; const opt = parts[1];
          grouped[base] = grouped[base] || []; if (el.checked) grouped[base].push(opt);
        } else if (el.type === "radio") {
          // handled later
        } else if (el.type === "checkbox") {
          grouped[rawKey] = grouped[rawKey] || []; if (el.checked) grouped[rawKey].push(el.value);
        } else {
          grouped[rawKey] = el.value || "";
        }
      });
      const radios = document.querySelectorAll("input[type=radio]"); const radioNames = new Set();
      radios.forEach(r => radioNames.add(r.name));
      radioNames.forEach(name => { const sel = document.querySelector(`input[name="${name}"]:checked`); grouped[name] = sel ? sel.value : ""; });

      // ensure region & state are present if city chosen
      if (grouped.city) {
        const region = cityToRegion[grouped.city] || "";
        const state = cityToState[grouped.city] || "";
        if (region) grouped.region = region;
        if (state) grouped.state = state;
      }

      // convert arrays to comma strings
      const answers = {};
      Object.keys(grouped).forEach(k => answers[k] = Array.isArray(grouped[k]) ? grouped[k].join(", ") : grouped[k]);

      const payload = { sessionId, submitted: true, answers };
      try {
        const res = await fetch(WEBAPP_URL, { method: "POST", body: JSON.stringify(payload) });
        await res.text();
        document.getElementById("submitMsg").textContent = "Thanks bruh ‚Äî we‚Äôll bring your picks to the next drop. üí™";
      } catch (err) {
        console.error("Submit failed", err);
        document.getElementById("submitMsg").textContent = "Submission failed ‚Äî try again.";
      }
    }

    // ===== clear local draft =====
    function clearDraft() {
      localStorage.removeItem("sf_session_id");
      document.getElementById("submitMsg").textContent = "Local draft cleared. Reload the page to start a new session.";
    }

    // ===== initialize =====
    (async function init() {
      const config = await loadConfig();
      buildForm(config);
      document.getElementById("submitBtn").addEventListener("click", submitAll);
      document.getElementById("clearBtn").addEventListener("click", clearDraft);
      setInterval(updateProgressUI, 700);
    })();
  </script>
</body>
</html>
